<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 網頁資料擷取 | 輕鬆學習 R 語言</title>
  <meta name="description" content="從基礎到應用，掌握資料科學的關鍵能力。" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 網頁資料擷取 | 輕鬆學習 R 語言" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="從基礎到應用，掌握資料科學的關鍵能力。" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 網頁資料擷取 | 輕鬆學習 R 語言" />
  
  <meta name="twitter:description" content="從基礎到應用，掌握資料科學的關鍵能力。" />
  

<meta name="author" content="郭耀仁" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="otherDataStructures.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">輕鬆學習 R 語言</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 關於本書</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#誰是本書的目標讀者"><i class="fa fa-check"></i><b>1.1</b> 誰是本書的目標讀者</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#誰可能不是本書的目標讀者"><i class="fa fa-check"></i><b>1.2</b> 誰可能不是本書的目標讀者</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#程式區塊"><i class="fa fa-check"></i><b>1.3</b> 程式區塊</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#環境與版本"><i class="fa fa-check"></i><b>1.4</b> 環境與版本</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="gettingStarted.html"><a href="gettingStarted.html"><i class="fa fa-check"></i><b>2</b> 起步走</a><ul>
<li class="chapter" data-level="2.1" data-path="gettingStarted.html"><a href="gettingStarted.html#開發環境直譯器-r"><i class="fa fa-check"></i><b>2.1</b> 開發環境：直譯器 R</a></li>
<li class="chapter" data-level="2.2" data-path="gettingStarted.html"><a href="gettingStarted.html#開發環境整合開發環境-rstudio"><i class="fa fa-check"></i><b>2.2</b> 開發環境：整合開發環境 RStudio</a></li>
<li class="chapter" data-level="2.3" data-path="gettingStarted.html"><a href="gettingStarted.html#啟動-rstudio"><i class="fa fa-check"></i><b>2.3</b> 啟動 RStudio</a></li>
<li class="chapter" data-level="2.4" data-path="gettingStarted.html"><a href="gettingStarted.html#整合開發環境-rstudio-介面"><i class="fa fa-check"></i><b>2.4</b> 整合開發環境 RStudio 介面</a></li>
<li class="chapter" data-level="2.5" data-path="gettingStarted.html"><a href="gettingStarted.html#挑選-rstudio-佈景主題色彩"><i class="fa fa-check"></i><b>2.5</b> 挑選 RStudio 佈景主題色彩</a></li>
<li class="chapter" data-level="2.6" data-path="gettingStarted.html"><a href="gettingStarted.html#r-程式設計起步走"><i class="fa fa-check"></i><b>2.6</b> R 程式設計起步走</a></li>
<li class="chapter" data-level="2.7" data-path="gettingStarted.html"><a href="gettingStarted.html#簡單常用的-r-內建函數"><i class="fa fa-check"></i><b>2.7</b> 簡單常用的 R 內建函數</a></li>
<li class="chapter" data-level="2.8" data-path="gettingStarted.html"><a href="gettingStarted.html#r-console-一直出現-的故障排除"><i class="fa fa-check"></i><b>2.8</b> R Console 一直出現 + 的故障排除</a></li>
<li class="chapter" data-level="2.9" data-path="gettingStarted.html"><a href="gettingStarted.html#小結"><i class="fa fa-check"></i><b>2.9</b> 小結</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="otherDataStructures.html"><a href="otherDataStructures.html"><i class="fa fa-check"></i><b>3</b> 其他資料結構</a><ul>
<li class="chapter" data-level="3.1" data-path="otherDataStructures.html"><a href="otherDataStructures.html#彈性的容器清單list"><i class="fa fa-check"></i><b>3.1</b> 彈性的容器：清單（list）</a></li>
<li class="chapter" data-level="3.2" data-path="otherDataStructures.html"><a href="otherDataStructures.html#現代化表格資料框data.frame"><i class="fa fa-check"></i><b>3.2</b> 現代化表格：資料框（data.frame）</a></li>
<li class="chapter" data-level="3.3" data-path="otherDataStructures.html"><a href="otherDataStructures.html#有階層資訊的向量因素向量factor"><i class="fa fa-check"></i><b>3.3</b> 有階層資訊的向量：因素向量（factor）</a></li>
<li class="chapter" data-level="3.4" data-path="otherDataStructures.html"><a href="otherDataStructures.html#兩個維度的向量矩陣matrix"><i class="fa fa-check"></i><b>3.4</b> 兩個維度的向量：矩陣（matrix）</a></li>
<li class="chapter" data-level="3.5" data-path="otherDataStructures.html"><a href="otherDataStructures.html#多個維度的向量陣列array"><i class="fa fa-check"></i><b>3.5</b> 多個維度的向量：陣列（array）</a></li>
<li class="chapter" data-level="3.6" data-path="otherDataStructures.html"><a href="otherDataStructures.html#小結-1"><i class="fa fa-check"></i><b>3.6</b> 小結</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="webScraping.html"><a href="webScraping.html"><i class="fa fa-check"></i><b>4</b> 網頁資料擷取</a><ul>
<li class="chapter" data-level="4.1" data-path="webScraping.html"><a href="webScraping.html#網站爬蟲的核心任務"><i class="fa fa-check"></i><b>4.1</b> 網站爬蟲的核心任務</a></li>
<li class="chapter" data-level="4.2" data-path="webScraping.html"><a href="webScraping.html#安裝與載入套件"><i class="fa fa-check"></i><b>4.2</b> 安裝與載入套件</a></li>
<li class="chapter" data-level="4.3" data-path="webScraping.html"><a href="webScraping.html#擷取-json-格式資料"><i class="fa fa-check"></i><b>4.3</b> 擷取 JSON 格式資料</a></li>
<li class="chapter" data-level="4.4" data-path="webScraping.html"><a href="webScraping.html#擷取-xml-格式資料"><i class="fa fa-check"></i><b>4.4</b> 擷取 XML 格式資料</a></li>
<li class="chapter" data-level="4.5" data-path="webScraping.html"><a href="webScraping.html#擷取-html-格式資料"><i class="fa fa-check"></i><b>4.5</b> 擷取 HTML 格式資料</a></li>
<li class="chapter" data-level="4.6" data-path="webScraping.html"><a href="webScraping.html#chrome-瀏覽器外掛selector-gadget"><i class="fa fa-check"></i><b>4.6</b> Chrome 瀏覽器外掛：Selector Gadget</a></li>
<li class="chapter" data-level="4.7" data-path="webScraping.html"><a href="webScraping.html#chrome-瀏覽器外掛xpath-helper"><i class="fa fa-check"></i><b>4.7</b> Chrome 瀏覽器外掛：XPath Helper</a></li>
<li class="chapter" data-level="4.8" data-path="webScraping.html"><a href="webScraping.html#小結-2"><i class="fa fa-check"></i><b>4.8</b> 小結</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">輕鬆學習 R 語言</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="webScraping" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> 網頁資料擷取</h1>
<blockquote>
<p>The world’s most valuable resource is no longer oil, but data.</p>
<p>The Economist</p>
</blockquote>
<p>獲取資料（Getting Data）在資料科學專案中扮演攻擊發起點，如果這個專案目的是協助我們制定資料驅動的策略（data-driven strategy），而非傳統倚賴直覺的「根據經驗」策略，那麼為專案細心盤點資料來源與整理獲取方法，將可以為決策奠基穩固的基礎。常見的資料來源可以分為三種：
1. 檔案。
2. 資料庫。
3. 網頁資料擷取。</p>
<p>在資料輸入與輸出我們討論了如何透過 R 語言載入表格式檔案（包含 CSV 資料、Excel 試算表）、非表格式檔案（包含 TXT 資料、JSON 資料）；在向資料庫查詢我們簡介如何以 R 語言透過 DBI 與 RSQLite 兩個套件連結本機端的 SQLite 資料庫，並利用 DBI 套件所提供的函數實踐四種常見資料庫表格操作，即所謂的 CRUD：Create、Read、Update 與 Delete。這個小節我們要討論第三種資料來源：網頁，而從網頁擷取資料的技巧，有著另外一個更為眾人耳熟能詳的名稱：網站爬蟲。</p>
<div id="網站爬蟲的核心任務" class="section level2">
<h2><span class="header-section-number">4.1</span> 網站爬蟲的核心任務</h2>
<p>網站爬蟲的核心任務可以簡單區分為兩個：請求資料（requesting data）與解析資料（parsing data）；其中請求資料的運作就像我們在瀏覽器中輸入網址一般，只不過送出請求的管道由瀏覽器改變成為 R 語言程式碼；解析資料的運作則是將伺服器回傳的資料內容去蕪存菁，萃取必要的一小部分。
接著我們可依照解析資料的複雜程度將任務再細分為三類：JSON（全名為 JavaScript Object Notation，一種輕量級的資料交換格式）、XML（全名為 Extensible Markup Language）與 HTML（全名為 HyperText Markup Language）。很多的 Web API（全名為 Web Application Programming Interface，意即建構於網站伺服器的應用程式介面，作為不同系統之間的資料傳遞管道）其資料格式皆約定為 JSON 與 XML。如果資料格式是 JSON 在請求資料之後會以 R 語言的 <code>list</code> 或 <code>data.frame</code> 結構儲存，幾乎沒有額外的解析需求；假使資料格式是標記語言（XML 或 HTML），則會需要繼續以 XPath（提供在 XML/HTML 資料中以 XML 節點找尋特定資料位置的定位方法）或 CSS Selector（提供在 HTML 資料中以層疊樣式表找尋特定資料位置的定位方法）來解析。</p>
</div>
<div id="安裝與載入套件" class="section level2">
<h2><span class="header-section-number">4.2</span> 安裝與載入套件</h2>
<p>在這個小節中我們主要應用作為網頁資料擷取的套件是 jsonlite、xml2、magrittr 與 rvest，其中 magrittr 是為了使用 <code>%&gt;%</code> 搭配 rvest 中的函數、xml2 是 rvest 的依賴套件，因此安裝時只需指定 jsonlite、rvest 與 magrittr 即可。
我們可以選擇透過命令列（Console）以 <code>install.packages()</code> 函數進行安裝。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="webScraping.html#cb1-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb1-2"><a href="webScraping.html#cb1-2"></a>pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;jsonlite&quot;</span>, <span class="st">&quot;rvest&quot;</span>, <span class="st">&quot;magrittr&quot;</span>)</span>
<span id="cb1-3"><a href="webScraping.html#cb1-3"></a><span class="kw">install.packages</span>(pkgs)</span></code></pre></div>
<p>或是透過圖形化介面（Graphic User Interface, GUI）的方法安裝，在右下角的 packages 頁籤點選 install，再輸入套件名稱接著點選安裝。</p>
<div class="figure">
<img src="img/chapter17/install_pkgs.png" alt="" />
<p class="caption">透過圖形化介面安裝</p>
</div>
<p>我們可以選擇透過命令列（Console）以 <code>library()</code> 函數將套件載入環境來使用。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="webScraping.html#cb2-1"></a><span class="co"># 載入 jsonlite、rvest 與 magrittr</span></span>
<span id="cb2-2"><a href="webScraping.html#cb2-2"></a><span class="kw">library</span>(jsonlite)</span>
<span id="cb2-3"><a href="webScraping.html#cb2-3"></a><span class="kw">library</span>(rvest)</span></code></pre></div>
<pre><code>## Loading required package: xml2</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="webScraping.html#cb4-1"></a><span class="kw">library</span>(magrittr)</span></code></pre></div>
<p>或是透過圖形化介面（Graphic User Interface, GUI）在右下角的 packages頁籤下搜尋然後將前面的核取方框打勾。</p>
</div>
<div id="擷取-json-格式資料" class="section level2">
<h2><span class="header-section-number">4.3</span> 擷取 JSON 格式資料</h2>
<p>接著我們以 jsonlite 套件中的 <code>fromJSON()</code> 函數示範擷取政府資料開放平台：空氣品質指標（AQI）所提供的 Web API 將 JSON 格式資料載入 R 語言中，由於該 Web API 提供的是 Array of JSON，因此擷取之後的資料結構是 <code>data.frame</code>。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="webScraping.html#cb5-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb5-2"><a href="webScraping.html#cb5-2"></a><span class="co">#pkgs &lt;- c(&quot;jsonlite&quot;, &quot;rvest&quot;, &quot;magrittr&quot;)</span></span>
<span id="cb5-3"><a href="webScraping.html#cb5-3"></a><span class="co">#install.packages(pkgs)</span></span>
<span id="cb5-4"><a href="webScraping.html#cb5-4"></a><span class="co"># 載入 jsonlite</span></span>
<span id="cb5-5"><a href="webScraping.html#cb5-5"></a><span class="kw">library</span>(jsonlite)</span>
<span id="cb5-6"><a href="webScraping.html#cb5-6"></a></span>
<span id="cb5-7"><a href="webScraping.html#cb5-7"></a>aqi_url &lt;-<span class="st"> &quot;https://opendata.epa.gov.tw/ws/Data/AQI/?$format=json&quot;</span></span>
<span id="cb5-8"><a href="webScraping.html#cb5-8"></a>aqi &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(aqi_url)</span>
<span id="cb5-9"><a href="webScraping.html#cb5-9"></a><span class="kw">class</span>(aqi)</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="webScraping.html#cb7-1"></a><span class="kw">head</span>(aqi)</span></code></pre></div>
<pre><code>##     SiteName County AQI  Pollutant           Status SO2   CO CO_8hr   O3 O3_8hr
## 1 屏東(枋寮) 屏東縣 115 細懸浮微粒 對敏感族群不健康 0.5 0.31    0.3 31.2     51
## 2 新竹(北區) 新竹市  90 細懸浮微粒             普通   1 0.63    0.6  7.6     25
## 3 新北(樹林) 新北市  52 細懸浮微粒             普通 0.5 0.45    0.4 27.5     31
## 4 臺南(北門) 臺南市 118 細懸浮微粒 對敏感族群不健康 0.5 0.43    0.4 33.7     37
## 5 屏東(琉球) 屏東縣  97 臭氧八小時             普通 0.5 0.24    0.4 45.5     69
## 6 臺南(麻豆) 臺南市 152 細懸浮微粒 對所有族群不健康 0.5 0.46    0.5 37.9     47
##   PM10 PM2.5  NO2  NOx  NO WindSpeed WindDirec         PublishTime PM2.5_AVG
## 1   45    27 18.6 19.5 0.8       0.5        33 2021/02/07 22:00:00        41
## 2   52    33 27.2 29.4 2.2       0.3       353 2021/02/07 22:00:00        32
## 3    -    16 16.8 20.7 3.9       0.5       138 2021/02/07 22:00:00        16
## 4   70    47 10.8   11 0.3       0.9        38 2021/02/07 22:00:00        42
## 5   28    15  0.3    1 0.7       0.3       176 2021/02/07 22:00:00        31
## 6   81    60 10.2 11.2   1       1.1       352 2021/02/07 22:00:00        57
##   PM10_AVG SO2_AVG    Longitude    Latitude SiteId
## 1       72       1 120.59116667 22.37094722    313
## 2       49       1 120.96231389 24.81953333    312
## 3        -       1 121.38352778 24.94902778    311
## 4       68       1 120.12444444 23.26472222    310
## 5       51       2    120.37722    22.35222    204
## 6       82       1 120.24583056 23.17904722    203</code></pre>
<p>同樣以 jsonlite 套件中的 <code>fromJSON()</code> 函數示範擷取 data.nba.net 所提供的 Web API 將 JSON 格式資料載入 R 語言中，這時由於該 Web API 提供的是 JSON，擷取之後的資料結構則會是 <code>list</code>。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="webScraping.html#cb9-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb9-2"><a href="webScraping.html#cb9-2"></a><span class="co">#pkgs &lt;- c(&quot;jsonlite&quot;, &quot;rvest&quot;, &quot;magrittr&quot;)</span></span>
<span id="cb9-3"><a href="webScraping.html#cb9-3"></a><span class="co">#install.packages(pkgs)</span></span>
<span id="cb9-4"><a href="webScraping.html#cb9-4"></a><span class="co"># 載入 jsonlite</span></span>
<span id="cb9-5"><a href="webScraping.html#cb9-5"></a><span class="kw">library</span>(jsonlite)</span>
<span id="cb9-6"><a href="webScraping.html#cb9-6"></a></span>
<span id="cb9-7"><a href="webScraping.html#cb9-7"></a>nba_url &lt;-<span class="st"> &quot;https://data.nba.net/prod/v1/2020/players.json&quot;</span></span>
<span id="cb9-8"><a href="webScraping.html#cb9-8"></a>nba_players &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(nba_url)</span>
<span id="cb9-9"><a href="webScraping.html#cb9-9"></a><span class="kw">class</span>(nba_players)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="webScraping.html#cb11-1"></a><span class="kw">paste</span>(nba_players<span class="op">$</span>league<span class="op">$</span>standard<span class="op">$</span>firstName, nba_players<span class="op">$</span>league<span class="op">$</span>standard<span class="op">$</span>lastName)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;Precious Achiuwa&quot;         &quot;Jaylen Adams&quot;            
##  [3] &quot;Steven Adams&quot;             &quot;Bam Adebayo&quot;             
##  [5] &quot;LaMarcus Aldridge&quot;        &quot;Ty-Shon Alexander&quot;       
##  [7] &quot;Nickeil Alexander-Walker&quot; &quot;Grayson Allen&quot;           
##  [9] &quot;Jarrett Allen&quot;            &quot;Al-Farouq Aminu&quot;</code></pre>
</div>
<div id="擷取-xml-格式資料" class="section level2">
<h2><span class="header-section-number">4.4</span> 擷取 XML 格式資料</h2>
<p>接著我們利用 xml2 套件示範擷取政府資料開放平台：空氣品質指標（AQI）所提供的 Web API 將 XML 格式資料載入 R 語言中，使用 <code>read_xml()</code> 函數之後獲得的資料結構是命名為 xml_document 的 <code>list</code>，面對 xml_document 可以呼叫 xml2 套件提供的 <code>xml_find_all()</code> 與 <code>xml_text()</code> 函數指定 XPath 並解析出文字格式的資料。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="webScraping.html#cb13-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb13-2"><a href="webScraping.html#cb13-2"></a><span class="co">#pkgs &lt;- c(&quot;jsonlite&quot;, &quot;rvest&quot;, &quot;magrittr&quot;)</span></span>
<span id="cb13-3"><a href="webScraping.html#cb13-3"></a><span class="co">#install.packages(pkgs)</span></span>
<span id="cb13-4"><a href="webScraping.html#cb13-4"></a><span class="co"># 載入 xml2, magrittr</span></span>
<span id="cb13-5"><a href="webScraping.html#cb13-5"></a><span class="kw">library</span>(xml2)</span>
<span id="cb13-6"><a href="webScraping.html#cb13-6"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb13-7"><a href="webScraping.html#cb13-7"></a></span>
<span id="cb13-8"><a href="webScraping.html#cb13-8"></a>aqi_url &lt;-<span class="st"> &quot;https://opendata.epa.gov.tw/ws/Data/AQI/?$format=xml&quot;</span></span>
<span id="cb13-9"><a href="webScraping.html#cb13-9"></a>aqi &lt;-<span class="st"> </span><span class="kw">read_xml</span>(aqi_url)</span>
<span id="cb13-10"><a href="webScraping.html#cb13-10"></a><span class="kw">class</span>(aqi)</span></code></pre></div>
<pre><code>## [1] &quot;xml_document&quot; &quot;xml_node&quot;</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="webScraping.html#cb15-1"></a>site_names &lt;-<span class="st"> </span>aqi <span class="op">%&gt;%</span></span>
<span id="cb15-2"><a href="webScraping.html#cb15-2"></a><span class="st">  </span><span class="kw">xml_find_all</span>(<span class="dt">xpath =</span> <span class="st">&quot;//Data/SiteName&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-3"><a href="webScraping.html#cb15-3"></a><span class="st">  </span><span class="kw">xml_text</span>()</span>
<span id="cb15-4"><a href="webScraping.html#cb15-4"></a><span class="kw">class</span>(site_names)</span></code></pre></div>
<pre><code>## [1] &quot;character&quot;</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="webScraping.html#cb17-1"></a>site_names</span></code></pre></div>
<pre><code>##  [1] &quot;屏東(枋寮)&quot; &quot;新竹(北區)&quot; &quot;新北(樹林)&quot; &quot;臺南(北門)&quot; &quot;屏東(琉球)&quot;
##  [6] &quot;臺南(麻豆)&quot; &quot;彰化(大城)&quot; &quot;彰化(員林)&quot; &quot;富貴角&quot;     &quot;麥寮&quot;      
## [11] &quot;關山&quot;       &quot;馬公&quot;       &quot;金門&quot;       &quot;馬祖&quot;       &quot;埔里&quot;      
## [16] &quot;復興&quot;       &quot;永和&quot;       &quot;竹山&quot;       &quot;中壢&quot;       &quot;三重&quot;      
## [21] &quot;冬山&quot;       &quot;宜蘭&quot;       &quot;陽明&quot;       &quot;花蓮&quot;       &quot;臺東&quot;      
## [26] &quot;恆春&quot;       &quot;潮州&quot;       &quot;屏東&quot;       &quot;小港&quot;       &quot;前鎮&quot;      
## [31] &quot;前金&quot;       &quot;左營&quot;       &quot;楠梓&quot;       &quot;林園&quot;       &quot;大寮&quot;      
## [36] &quot;鳳山&quot;       &quot;仁武&quot;       &quot;橋頭&quot;       &quot;美濃&quot;       &quot;臺南&quot;      
## [41] &quot;安南&quot;       &quot;善化&quot;       &quot;新營&quot;       &quot;嘉義&quot;       &quot;臺西&quot;      
## [46] &quot;朴子&quot;       &quot;新港&quot;       &quot;崙背&quot;       &quot;斗六&quot;       &quot;南投&quot;      
## [51] &quot;二林&quot;       &quot;線西&quot;       &quot;彰化&quot;       &quot;西屯&quot;       &quot;忠明&quot;      
## [56] &quot;大里&quot;       &quot;沙鹿&quot;       &quot;豐原&quot;       &quot;三義&quot;       &quot;苗栗&quot;      
## [61] &quot;頭份&quot;       &quot;新竹&quot;       &quot;竹東&quot;       &quot;湖口&quot;       &quot;龍潭&quot;      
## [66] &quot;平鎮&quot;       &quot;觀音&quot;       &quot;大園&quot;       &quot;桃園&quot;       &quot;大同&quot;      
## [71] &quot;松山&quot;       &quot;古亭&quot;       &quot;萬華&quot;       &quot;中山&quot;       &quot;士林&quot;      
## [76] &quot;淡水&quot;       &quot;林口&quot;       &quot;菜寮&quot;       &quot;新莊&quot;       &quot;板橋&quot;      
## [81] &quot;土城&quot;       &quot;新店&quot;       &quot;萬里&quot;       &quot;汐止&quot;       &quot;基隆&quot;</code></pre>
</div>
<div id="擷取-html-格式資料" class="section level2">
<h2><span class="header-section-number">4.5</span> 擷取 HTML 格式資料</h2>
<p>向伺服器發送請求後若是獲得 HTML 格式資料，將需要進行較複雜的解析任務，原因是請求後的 HTML 文件包含了太多不需要的資訊，諸如包含在 <code>&lt;style&gt;&lt;/style&gt;</code> 標籤中的 CSS（Cascading Style Sheets，階層樣式表）語言或者包含在 <code>&lt;script&gt;&lt;/script&gt;</code> 標籤中的 JavaScript 語言。
所以熟練定位網頁中特定資料位址的技巧就變得十分重要，如同在地圖上加入標記（Marker）一般，我們需要景點或建築物的位址，可以是門牌號碼、詳細地址甚至是精準的經緯度。在網頁上標記資料為止有非常多方法能夠表示，常見的像是使用：</p>
<ul>
<li>HTML 的標籤名稱。</li>
<li>HTML 標籤中給予的 id。</li>
<li>HTML 標籤中給予的 class。</li>
<li>CSS 選擇器（CSS Selector）。</li>
<li>XPath。</li>
</ul>
<p>考量多數資料科學愛好者並不具備網頁工程師的背景技能，透過 Chrome 瀏覽器的外掛來取得資料所在的 CSS 選擇器或者 XPath 是快速入門的捷徑。</p>
</div>
<div id="chrome-瀏覽器外掛selector-gadget" class="section level2">
<h2><span class="header-section-number">4.6</span> Chrome 瀏覽器外掛：Selector Gadget</h2>
<p>透過下列步驟將 Selector Gadget 外掛加入 Chrome 瀏覽器。</p>
<ol style="list-style-type: decimal">
<li>前往 Chrome Web Store，點選外掛（Extensions）。</li>
</ol>
<p><img src="img/chapter17/chrome_extensions.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li>搜尋 Selector Gadget 並點選加入到 Chrome 瀏覽器。</li>
</ol>
<p><img src="img/chapter17/search_selector_gadget.png" /></p>
<ol start="3" style="list-style-type: decimal">
<li>確認要加入 Selector Gadget。</li>
</ol>
<p><img src="img/chapter17/add_selector_gadget.png" /></p>
<p>依照下列步驟定位 HTML 格式資料的 CSS 選擇器。</p>
<ol style="list-style-type: decimal">
<li>點選 Selector Gadget 的外掛圖示。</li>
</ol>
<p><img src="img/chapter17/selector_gadget_1.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li>留意 Selector Gadget 的 CSS 選擇器。</li>
</ol>
<p><img src="img/chapter17/selector_gadget_2.png" /></p>
<ol start="3" style="list-style-type: decimal">
<li><p>移動滑鼠到想要定位的元素。</p></li>
<li><p>在想要定位的評分上面點選左鍵，留意此時的 CSS 選擇器位址與資料筆數，通常在第一次點擊後網頁上很多的資料都會同時被選到（以黃底標記），Clear 後面數字表示有多少筆。</p></li>
</ol>
<p><img src="img/chapter17/selector_gadget_4.png" /></p>
<ol start="5" style="list-style-type: decimal">
<li>移動滑鼠點選不要選擇的元素（改以紅底標記），並同時注意 CSS 選擇器位址與資料筆數的變動，當資料筆數與預期相符時表示完成定位。</li>
</ol>
<p><img src="img/chapter17/selector_gadget_5.png" /></p>
<p>我們以 IMDB.com 的 Avengers: Infinity War (2018) 頁面示範如何以 CSS 選擇器定位評等。
利用 rvest 套件的 <code>read_html()</code> 函數將 HTML 資料格式讀入，獲得的資料結構同樣是命名為 xml_document 的 <code>list</code>，面對 xml_document 可以呼叫 rvest 套件提供的 <code>html_nodes()</code> 與 <code>html_text()</code> 函數指定 CSS 選擇器解析出文字格式的資料。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="webScraping.html#cb19-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb19-2"><a href="webScraping.html#cb19-2"></a><span class="co">#pkgs &lt;- c(&quot;jsonlite&quot;, &quot;rvest&quot;, &quot;magrittr&quot;)</span></span>
<span id="cb19-3"><a href="webScraping.html#cb19-3"></a><span class="co">#install.packages(pkgs)</span></span>
<span id="cb19-4"><a href="webScraping.html#cb19-4"></a><span class="co"># 載入 rvest, magrittr</span></span>
<span id="cb19-5"><a href="webScraping.html#cb19-5"></a><span class="kw">library</span>(rvest)</span>
<span id="cb19-6"><a href="webScraping.html#cb19-6"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb19-7"><a href="webScraping.html#cb19-7"></a></span>
<span id="cb19-8"><a href="webScraping.html#cb19-8"></a>movie_url &lt;-<span class="st"> &quot;https://www.imdb.com/title/tt4154756&quot;</span></span>
<span id="cb19-9"><a href="webScraping.html#cb19-9"></a>movie &lt;-<span class="st"> </span><span class="kw">read_html</span>(movie_url)</span>
<span id="cb19-10"><a href="webScraping.html#cb19-10"></a><span class="kw">class</span>(movie)</span></code></pre></div>
<pre><code>## [1] &quot;xml_document&quot; &quot;xml_node&quot;</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="webScraping.html#cb21-1"></a>rating &lt;-<span class="st"> </span>movie <span class="op">%&gt;%</span></span>
<span id="cb21-2"><a href="webScraping.html#cb21-2"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="dt">css =</span> <span class="st">&quot;strong span&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb21-3"><a href="webScraping.html#cb21-3"></a><span class="st">  </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb21-4"><a href="webScraping.html#cb21-4"></a><span class="st">  </span><span class="kw">as.numeric</span>()</span>
<span id="cb21-5"><a href="webScraping.html#cb21-5"></a>rating</span></code></pre></div>
<pre><code>## [1] 8.4</code></pre>
</div>
<div id="chrome-瀏覽器外掛xpath-helper" class="section level2">
<h2><span class="header-section-number">4.7</span> Chrome 瀏覽器外掛：XPath Helper</h2>
<p>透過下列步驟將 XPath Helper 外掛加入 Chrome 瀏覽器。</p>
<ol style="list-style-type: decimal">
<li>前往 Chrome Web Store，點選外掛（Extensions）。</li>
</ol>
<p><img src="img/chapter17/chrome_extensions.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li>搜尋 XPath Helper 並點選加入到 Chrome 瀏覽器。</li>
</ol>
<p><img src="img/chapter17/search_xpath_helper.png" /></p>
<ol start="3" style="list-style-type: decimal">
<li>確認要加入 XPath Helper。</li>
</ol>
<p><img src="img/chapter17/add_xpath_helper.png" /></p>
<p>依照下列步驟定位 HTML 格式資料的 XPath。</p>
<ol style="list-style-type: decimal">
<li>點選 XPath Helper 的外掛圖示。</li>
</ol>
<p><img src="img/chapter17/xpath_helper_1.png" /></p>
<ol start="2" style="list-style-type: decimal">
<li>留意 XPath Helper 介面左邊的 XPath 與右邊被定位到的資料。</li>
</ol>
<p><img src="img/chapter17/xpath_helper_2.png" /></p>
<ol start="3" style="list-style-type: decimal">
<li>按住 shift 鍵移動滑鼠到想要定位的資料。</li>
</ol>
<p><img src="img/chapter17/xpath_helper_3.png" /></p>
<ol start="4" style="list-style-type: decimal">
<li>試著縮減 XPath，從最前面的節點開始刪減，在最短的 XPath 依然能對應到資料即表示完成定位。</li>
</ol>
<p><img src="img/chapter17/xpath_helper_4.png" /></p>
<p>我們以 IMDB.com 的 Avengers: Infinity War (2018) 頁面示範如何以 XPath 定位評等。</p>
<p>利用 rvest 套件的 <code>read_html()</code> 函數將 HTML 資料格式讀入，獲得的資料結構同樣是命名為 xml_document 的 <code>list</code>，面對 xml_document 可以呼叫 rvest 套件提供的 <code>html_nodes()</code> 與 <code>html_text()</code> 函數指定 XPath 解析出文字格式的資料。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="webScraping.html#cb23-1"></a><span class="co"># 安裝 jsonlite、rvest 與 magrittr</span></span>
<span id="cb23-2"><a href="webScraping.html#cb23-2"></a><span class="co">#pkgs &lt;- c(&quot;jsonlite&quot;, &quot;rvest&quot;, &quot;magrittr&quot;)</span></span>
<span id="cb23-3"><a href="webScraping.html#cb23-3"></a><span class="co">#install.packages(pkgs)</span></span>
<span id="cb23-4"><a href="webScraping.html#cb23-4"></a><span class="co"># 載入 rvest, magrittr</span></span>
<span id="cb23-5"><a href="webScraping.html#cb23-5"></a><span class="kw">library</span>(rvest)</span>
<span id="cb23-6"><a href="webScraping.html#cb23-6"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb23-7"><a href="webScraping.html#cb23-7"></a></span>
<span id="cb23-8"><a href="webScraping.html#cb23-8"></a>movie_url &lt;-<span class="st"> &quot;https://www.imdb.com/title/tt4154756&quot;</span></span>
<span id="cb23-9"><a href="webScraping.html#cb23-9"></a>movie &lt;-<span class="st"> </span><span class="kw">read_html</span>(movie_url)</span>
<span id="cb23-10"><a href="webScraping.html#cb23-10"></a><span class="kw">class</span>(movie)</span></code></pre></div>
<pre><code>## [1] &quot;xml_document&quot; &quot;xml_node&quot;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="webScraping.html#cb25-1"></a>rating &lt;-<span class="st"> </span>movie <span class="op">%&gt;%</span></span>
<span id="cb25-2"><a href="webScraping.html#cb25-2"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="dt">xpath =</span> <span class="st">&quot;//strong/span&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-3"><a href="webScraping.html#cb25-3"></a><span class="st">  </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb25-4"><a href="webScraping.html#cb25-4"></a><span class="st">  </span><span class="kw">as.numeric</span>()</span>
<span id="cb25-5"><a href="webScraping.html#cb25-5"></a>rating</span></code></pre></div>
<pre><code>## [1] 8.4</code></pre>
</div>
<div id="小結-2" class="section level2">
<h2><span class="header-section-number">4.8</span> 小結</h2>
<p>在 Chapter <a href="webScraping.html#webScraping">4</a> 中我們簡介如何以 R 語言透過 jsonlite 、 xml2 與 rvest 等套件實踐網站爬蟲的核心任務：請求資料（requesting data）與解析資料（parsing data）。面對不同類型的網頁資料，分別以 jsonlite 套件的 <code>fromJSON()</code> 函數處理 Web API 的 JSON 格式資料；以 xml2 套件的 <code>read_xml()</code> 、 <code>xml_find_all()</code> 與 <code>xml_text()</code> 函數處理 Web API 的 XML 格式資料；以 rvest 套件的 <code>read_html()</code>、<code>html_nodes()</code> 與 <code>html_text()</code> 函數搭配 Chrome 瀏覽器外掛 Selector Gadget 以及 XPath Helper 處理 HTML 格式資料。</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="otherDataStructures.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["eloquent-r.pdf", "eloquent-r.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
